<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>接近感の測定実験（4ボタン・単発再生版）</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Hiragino Sans', 'Noto Sans CJK JP', 'Yu Gothic', sans-serif;
            background-color: #f0f0f0;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            text-align: center;
            overflow: hidden;
        }

        #container {
            background-color: #ffffff;
            padding: 2rem 2.5rem;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 800px;
        }

        /* --- 刺激エリア（左右分割） --- */
        #stimulus-container {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 1.5rem;
        }

        .stimulus-box {
            width: 48%;
            height: 350px; /* 高さを少し増やす */
            border: 2px solid #ddd;
            background-color: #fafafa;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            box-sizing: border-box;
            perspective: 500px;
            overflow: hidden;
            position: relative; /* 再生ボタンを配置するため */
        }
        .stimulus-box h3 {
            margin-top: 0;
            color: #555;
            height: 20px;
        }

        /* アニメーション表示領域 */
        .stimulus-content {
            width: 100%;
            height: 250px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- アニメーション定義 --- */
        @keyframes zoom-in-once {
            0%   { transform: scale(0.1) translateZ(0px); opacity: 0.5; }
            50%  { transform: scale(var(--max-scale, 1.5)) translateZ(150px); opacity: 1; }
            100% { transform: scale(0.1) translateZ(0px); opacity: 0.5; }
        }

        /* --- 刺激のスタイル --- */
        
        /* 共通の円要素 */
        .animated-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            
            /* ★浮遊感のある影 */
            box-shadow: 0px 40px 30px -10px rgba(0, 0, 0, 0.3);

            /* CSS変数 */
            --max-scale: 1.5;
            --anim-duration: 3.0s;
            
            /* 初期状態 */
            transform: scale(0.1) translateZ(0px);
            opacity: 0.5;
        }

        /* ★単発再生用のクラス */
        .animated-circle.is-animating {
            animation-name: zoom-in-once;
            animation-duration: var(--anim-duration);
            animation-iteration-count: 1; /* 1回だけ再生 */
            animation-timing-function: ease-in-out;
            /* アニメーション終了後に初期状態(0%)に戻る */
            animation-fill-mode: backwards; 
        }

        /* 再生ボタン (左右共通) */
        .stimulus-play-btn {
            position: absolute;
            bottom: 15px;
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
            background-color: #007aff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            z-index: 10;
        }
        .stimulus-play-btn:hover {
            background-color: #0056b3;
        }
        .stimulus-play-btn:disabled {
            background-color: #808080;
            cursor: not-allowed;
        }


        /* 調整用ボタンエリア */
        #response-area { margin-top: 1rem; }
        #speed-controls {
            display: flex;
            justify-content: space-around;
            margin: 1rem 0;
        }
        #speed-controls button {
            font-size: 0.9rem;
            padding: 0.6rem 0.8rem;
            background-color: #555;
            min-width: 80px;
        }
        #speed-controls button.active {
            background-color: #007aff; /* 選択中のレベル */
            box-shadow: 0 0 10px rgba(0, 122, 255, 0.5);
        }

        #current-speed-display {
            font-weight: bold;
            color: #333;
            font-size: 1.1rem;
            margin-top: 0.5rem;
            height: 20px;
        }

        /* その他 */
        button {
            border: none;
            border-radius: 5px;
            cursor: pointer;
            color: white;
            transition: background-color 0.2s;
        }
        #start-btn { font-size: 1.1rem; padding: 0.8rem 1.5rem; background-color: #4CAF50; }
        #next-btn { font-size: 1.1rem; padding: 0.8rem 1.5rem; background-color: #007aff; margin-top: 1rem;}
        
        #results-area {
            text-align: left; background-color: #f9f9f9; border: 1px solid #eee;
            padding: 1rem; border-radius: 5px; white-space: pre-wrap;
            font-family: 'Courier New', Courier, monospace; max-height: 200px; overflow-y: auto;
        }
        #start-screen, #experiment-screen, #results-screen { display: none; }
        #start-screen { display: block; }

    </style>
</head>
<body>

    <div id="container">
        <div id="start-screen">
            <h1>接近感の測定実験 (4ボタン・単発再生版)</h1>
            <p>
                左右の「再生」ボタンを押すと、アニメーションが1回再生されます。<br>
                右側の「比較対象」の接近速度が、左の「基準」と同じに感じられるように、下の速度ボタンで調整してください。
            </p>
            <p>（同時に再生することはできません）</p>
            <button id="start-btn">実験を開始する</button>
        </div>

        <div id="experiment-screen">
            <h2 id="instruction"></h2>
            
            <div id="stimulus-container">
                <div class="stimulus-box">
                    <h3>基準 (速さ固定)</h3>
                    <div id="reference-stimulus-content" class="stimulus-content">
                        </div>
                    <button id="ref-play-btn" class="stimulus-play-btn">再生</button>
                </div>
                <div class="stimulus-box">
                    <h3 id="test-stimulus-title">比較対象 (速さ調整)</h3>
                    <div id="test-stimulus-content" class="stimulus-content">
                        </div>
                    <button id="test-play-btn" class="stimulus-play-btn">再生</button>
                </div>
            </div>
            
            <div id="response-area">
                <p><strong>右側のアニメーション速度を選択:</strong></p>
                <div id="speed-controls">
                    <button id="speed-level-0">より速く</button>
                    <button id="speed-level-1">速く</button>
                    <button id="speed-level-3">遅く</button>
                    <button id="speed-level-4">より遅く</button>
                </div>
                <div id="current-speed-display">現在の速度: 基準</div>
                <button id="speed-level-2" style="background-color: #6c757d;">基準に戻す</button>
            </div>
            
            <button id="next-btn">決定して次へ</button>
        </div>

        <div id="results-screen">
            <h2>実験結果</h2>
            <p>収集されたデータは以下の通りです。</p>
            <div id="results-area"></div>
            <button onclick="location.reload()">もう一度試す</button>
        </div>
    </div>

    <script>
        // --- 設定 ---
        
        // 速度レベル (5段階)
        // [0: より速く, 1: 速く, 2: 基準, 3: 遅く, 4: より遅く]
        const DURATION_LEVELS = [1.5, 2.25, 3.0, 3.75, 4.5]; // アニメーション周期 (秒)
        const LEVEL_NAMES = ["より速く", "速く", "基準", "遅く", "より遅く"];
        const BASE_LEVEL_INDEX = 2; // 基準レベルのインデックス

        // 音刺激のパラメーター
        const SOUND_PARAMS = {
            'Reference':   { freq: 600, gain: 0.5, max_scale: 1.5 }, // 基準音
            'HighPitch':   { freq: 1000, gain: 0.5, max_scale: 1.5 },
            'LowPitch':    { freq: 300, gain: 0.5, max_scale: 1.5 },
            'Loud':        { freq: 600, gain: 0.8, max_scale: 2.0 }, // 大きい音は大きく
            'Quiet':       { freq: 600, gain: 0.2, max_scale: 1.0 }, // 小さい音は小さく
        };

        // ★刺激リスト (RGBCMY)
        const stimuliList = [
            'Color-Red',
            'Color-Green',
            'Color-Blue',
            'Color-Cyan',
            'Color-Magenta',
            'Color-Yellow',
            'Sound-HighPitch',
            'Sound-LowPitch',
            'Sound-Loud',
            'Sound-Quiet',
        ];

        // --- グローバル変数 ---
        let currentStimulusIndex = 0;
        let shuffledStimuli = [];
        let results = [];
        let audioContext;
        let currentOscillator = null; // 同時再生禁止のため、一つだけ管理
        let currentTestLevelIndex = BASE_LEVEL_INDEX; // 比較対象の現在の速度レベル
        let isAnimating = false; // アニメーション再生中フラグ

        // --- DOM要素 ---
        const startScreen = document.getElementById('start-screen');
        const experimentScreen = document.getElementById('experiment-screen');
        const resultsScreen = document.getElementById('results-screen');
        const startBtn = document.getElementById('start-btn');
        const nextBtn = document.getElementById('next-btn');
        const instructionEl = document.getElementById('instruction');
        const speedDisplay = document.getElementById('current-speed-display');
        const refContentArea = document.getElementById('reference-stimulus-content');
        const testContentArea = document.getElementById('test-stimulus-content');
        const testTitle = document.getElementById('test-stimulus-title');
        const resultsArea = document.getElementById('results-area');
        const refPlayBtn = document.getElementById('ref-play-btn');
        const testPlayBtn = document.getElementById('test-play-btn');
        
        // 速度調整ボタン
        const speedButtons = [
            document.getElementById('speed-level-0'),
            document.getElementById('speed-level-1'),
            document.getElementById('speed-level-2'),
            document.getElementById('speed-level-3'),
            document.getElementById('speed-level-4'),
        ];

        // --- イベントリスナー ---
        startBtn.addEventListener('click', startExperiment);
        nextBtn.addEventListener('click', recordResponse);
        
        refPlayBtn.addEventListener('click', () => playStimulus('ref'));
        testPlayBtn.addEventListener('click', () => playStimulus('test'));

        // 速度ボタンのイベントリスナー
        speedButtons.forEach((button, index) => {
            button.addEventListener('click', () => {
                if (isAnimating) return;
                currentTestLevelIndex = index;
                updateTestStimulusSpeed();
            });
        });

        // --- 関数 ---

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function startExperiment() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) { alert('Web Audio APIはこのブラウザではサポートされていません。'); return; }
            
            shuffledStimuli = shuffleArray([...stimuliList]);
            currentStimulusIndex = 0;
            results = [];
            
            startScreen.style.display = 'none';
            experimentScreen.style.display = 'block';
            
            showNextStimulus();
        }

        // 比較対象の速度レベルを更新 (表示とCSS変数)
        function updateTestStimulusSpeed() {
            // 表示を更新
            speedDisplay.textContent = `現在の速度: ${LEVEL_NAMES[currentTestLevelIndex]}`;

            // ボタンのアクティブ状態を更新
            speedButtons.forEach((btn, idx) => {
                btn.classList.toggle('active', idx === currentTestLevelIndex);
            });
            
            // 比較対象の円要素のCSS変数を更新
            const testCircle = document.getElementById('test-stimulus');
            if (testCircle) {
                testCircle.style.setProperty('--anim-duration', `${DURATION_LEVELS[currentTestLevelIndex]}s`);
            }
        }

        // 次の刺激を提示
        function showNextStimulus() {
            stopAllStimuli(); // 念のため全て停止
            refContentArea.innerHTML = '';
            testContentArea.innerHTML = '';

            if (currentStimulusIndex >= shuffledStimuli.length) {
                showResults();
                return;
            }

            const stimulus = shuffledStimuli[currentStimulusIndex];
            currentTestLevelIndex = BASE_LEVEL_INDEX; // 速度レベルを基準にリセット

            let refColor = '#808080';
            let testColor = '#808080';
            let refScale = SOUND_PARAMS['Reference'].max_scale;
            let testScale = SOUND_PARAMS['Reference'].max_scale;
            let stimulusName = '';

            if (stimulus.startsWith('Color-')) {
                const color = stimulus.split('-')[1];
                instructionEl.textContent = `(${currentStimulusIndex + 1}/${shuffledStimuli.length}) 色の実験: 左右の円の速さを比較してください。`;
                testTitle.textContent = `比較対象 (${color})`;
                testColor = color;
                
            } else if (stimulus.startsWith('Sound-')) {
                const soundType = stimulus.split('-')[1];
                instructionEl.textContent = `(${currentStimulusIndex + 1}/${shuffledStimuli.length}) 音の実験: 左右の音と動きを比較してください。`;
                testTitle.textContent = `比較対象 (${soundType})`;
                
                // ★音の場合は比較対象もグレー
                testColor = '#808080';
                // 音の種類に応じて拡大率を変更
                testScale = SOUND_PARAMS[soundType].max_scale; 
            }

            // 基準（左）
            const refDiv = document.createElement('div');
            refDiv.id = 'reference-stimulus';
            refDiv.className = 'animated-circle';
            refDiv.style.backgroundColor = refColor;
            refDiv.style.setProperty('--max-scale', refScale);
            refDiv.style.setProperty('--anim-duration', `${DURATION_LEVELS[BASE_LEVEL_INDEX]}s`);
            refContentArea.appendChild(refDiv);
            
            // 比較（右）
            const testDiv = document.createElement('div');
            testDiv.id = 'test-stimulus';
            testDiv.className = 'animated-circle';
            testDiv.style.backgroundColor = testColor;
            testDiv.style.setProperty('--max-scale', testScale);
            // testDiv.style.setProperty('--anim-duration', ...); // updateTestStimulusSpeedで設定
            testContentArea.appendChild(testDiv);
            
            updateTestStimulusSpeed(); // 速度を初期化
        }

        // ★刺激再生（アニメーションと音）
        function playStimulus(side) {
            // 同時再生禁止
            if (isAnimating) return;
            
            stopAllStimuli(); // 既存の音を停止
            isAnimating = true;

            const stimulus = shuffledStimuli[currentStimulusIndex];
            
            let targetCircle;
            let targetButton;
            let durationSec;
            let soundType;

            if (side === 'ref') {
                targetCircle = document.getElementById('reference-stimulus');
                targetButton = refPlayBtn;
                durationSec = DURATION_LEVELS[BASE_LEVEL_INDEX];
                soundType = stimulus.startsWith('Sound-') ? 'Reference' : null;
            } else {
                targetCircle = document.getElementById('test-stimulus');
                targetButton = testPlayBtn;
                durationSec = DURATION_LEVELS[currentTestLevelIndex];
                soundType = stimulus.startsWith('Sound-') ? stimulus.split('-')[1] : null;
            }

            // 両方の再生ボタンを無効化
            refPlayBtn.disabled = true;
            testPlayBtn.disabled = true;
            targetButton.textContent = '再生中...';
            
            // 音を再生
            if (soundType) {
                playSound(soundType, durationSec);
            }

            // アニメーションを開始
            targetCircle.classList.add('is-animating');

            // アニメーション終了時の処理
            targetCircle.addEventListener('animationend', () => {
                targetCircle.classList.remove('is-animating');
                
                // 両方のボタンを有効化
                refPlayBtn.disabled = false;
                testPlayBtn.disabled = false;
                refPlayBtn.textContent = '再生';
                testPlayBtn.textContent = '再生';

                isAnimating = false;
            }, { once: true }); // イベントリスナーを1回限りで自動削除
        }

        // 音を再生 (指定された時間だけ)
        function playSound(type, durationSec) {
            const params = SOUND_PARAMS[type];
            if (!params) return;

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.type = 'sine';

            oscillator.frequency.setValueAtTime(params.freq, audioContext.currentTime);
            gainNode.gain.setValueAtTime(params.gain, audioContext.currentTime);

            oscillator.start();
            // ★アニメーションと同じ時間で音を停止
            oscillator.stop(audioContext.currentTime + durationSec);

            currentOscillator = oscillator;
        }

        // 全ての刺激（音）を停止
        function stopAllStimuli() {
            if (currentOscillator) {
                try { currentOscillator.stop(); } catch (e) {}
                currentOscillator = null;
            }
            
            // アニメーション中の場合、強制的に停止・リセット (複雑になるため今回は音の停止のみ)
            // isAnimating = false;
        }

        // 回答を記録
        function recordResponse() {
            stopAllStimuli();
            if (isAnimating) {
                alert("アニメーションが終了してから「決定」を押してください。");
                return;
            }

            const stimulus = shuffledStimuli[currentStimulusIndex];
            const adjustedAnimDuration = DURATION_LEVELS[currentTestLevelIndex];
            
            results.push({
                stimulus: stimulus,
                base_anim_duration_sec: DURATION_LEVELS[BASE_LEVEL_INDEX],
                adjusted_anim_duration_sec: adjustedAnimDuration,
                adjusted_level_index: currentTestLevelIndex
            });
            
            currentStimulusIndex++;
            showNextStimulus();
        }

        // 最終結果を表示
        function showResults() {
            experimentScreen.style.display = 'none';
            resultsScreen.style.display = 'block';
            
            let resultsText = "刺激, 基準速度(s), 調整速度(s), 調整レベル(0-4)\n";
            results.forEach(res => {
                resultsText += `${res.stimulus}, ${res.base_anim_duration_sec.toFixed(2)}, ${res.adjusted_anim_duration_sec.toFixed(2)}, ${res.adjusted_level_index}\n`;
            });

            resultsText += "\n--- JSONデータ ---\n";
            resultsText += JSON.stringify(results, null, 2);

            resultsArea.textContent = resultsText;
        }

    </script>

</body>
</html>