<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BREMONS</title>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style> .hidden { display: none !important; } </style>
</head>
<body>
    <audio id="bgm" src="./bgm/GuideToAdventure.mp3" loop></audio>
    <div class="game-container menu-screen">
        <div class="scrolling-bg"></div>
        <div class="floating-layer" id="floatingLayer"></div>

        <div class="ui-layer">
            <div class="title-area">
                <h1 class="game-title">BREMONS</h1>
                <span class="subtitle">- ブレモンズ -</span>
            </div>

            <div id="loginArea" class="menu-list">
                <p>パイロット認証が必要です</p>
                <button id="loginBtn" class="pixel-btn start-btn">Googleでログイン</button>
            </div>

            <nav id="menuArea" class="menu-list hidden">
                <p>ようこそ、宇宙飛行士<span id="userName" style="color:#f1c40f;">パイロット</span></p>
                <button onclick="startGame()" class="pixel-btn start-btn">ゲームスタート</button>
                <button onclick="location.href='log_view.html'" class="pixel-btn">軌跡をみる(グラフ)</button>
                
                <div style="display:flex; gap:10px; width:100%;">
                    <button onclick="location.href='ranking.html'" class="pixel-btn" style="flex:1; font-size:14px;">ランキング</button>
                    <button onclick="goBattle()" class="pixel-btn" style="flex:1; font-size:14px;">対戦(準備中)</button>
                </div>

                <button id="logoutBtn" class="pixel-btn" style="font-size:14px; background:#555;">ログアウト</button>
                
                <button id="resetDataBtn" class="pixel-btn" style="font-size:12px; background:#e74c3c; margin-top:20px;">⚠️ 自分のデータをリセット</button>
            </nav>
            
            <footer class="footer-area">
                <div class="version">Ver 3.1.0</div>
            </footer>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        // ★追加: writeBatch, doc, collection, getDocs をインポート
        import { getFirestore, doc, writeBatch, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCUWMn07YntLyB8m4q5-zHmiwjYOz1c_nk",
            authDomain: "bremons.firebaseapp.com",
            projectId: "bremons",
            storageBucket: "bremons.firebasestorage.app",
            messagingSenderId: "30413071482",
            appId: "1:30413071482:web:f62c34349b13e6c6ce47c3",
            measurementId: "G-4D4FCXGDBG"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app); // ★DB初期化
        const provider = new GoogleAuthProvider();

        const loginArea = document.getElementById('loginArea');
        const menuArea = document.getElementById('menuArea');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userNameSpan = document.getElementById('userName');

        loginBtn.addEventListener('click', () => {
            signInWithPopup(auth, provider).catch((error) => alert("ログイン失敗: " + error.message));
        });

        logoutBtn.addEventListener('click', () => { signOut(auth); });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginArea.classList.add('hidden');
                menuArea.classList.remove('hidden');
                userNameSpan.innerText = user.displayName || "名無しパイロット";
                localStorage.setItem('user_uid', user.uid);
                localStorage.setItem('user_name', user.displayName);
            } else {
                loginArea.classList.remove('hidden');
                menuArea.classList.add('hidden');
                localStorage.removeItem('user_uid');
            }
        });
        
        window.startGame = function() { window.location.href = "stage_select.html"; };
        window.goBattle = function() { alert("リアルタイム対戦は開発中です！"); };

        document.addEventListener('DOMContentLoaded', () => {
            const bgm = document.getElementById('bgm');
            bgm.volume = 0.3;
            bgm.play().catch(() => {});
            document.body.addEventListener('click', () => { if (bgm.paused) bgm.play(); }, { once: true });
        });

        // --- ★追加: データリセット処理 ---
        document.getElementById('resetDataBtn').addEventListener('click', async () => {
            const uid = localStorage.getItem('user_uid');
            if (!uid) return;

            if (!confirm("本当に自分のデータを全て初期化しますか？\n（ランキングや所持数も0になります）")) return;

            const btn = document.getElementById('resetDataBtn');
            btn.innerText = "削除中...";
            btn.disabled = true;

            try {
                const batch = writeBatch(db);
                const userRef = doc(db, "users", uid);

                // 1. ユーザー情報の初期化
                batch.set(userRef, {
                    displayName: localStorage.getItem('user_name'),
                    lastLogin: new Date().toISOString(),
                    inventory: { usa: 0, inv: 0, him: 0 },
                    totalGlobalDistance: 0,
                    maxSingleFlight: 0,
                    maxFuelDuration: 0,
                    totalStars: 0,
                    totalBlueStars: 0
                });

                // 2. ステージごとのログ削除
                const stagesRef = collection(db, "users", uid, "stages");
                const snapshot = await getDocs(stagesRef);
                snapshot.forEach((doc) => {
                    batch.delete(doc.ref);
                });

                await batch.commit();

                alert("リセット完了しました！");
                btn.innerText = "⚠️ 自分のデータをリセット";
                btn.disabled = false;
                
            } catch (e) {
                console.error(e);
                alert("エラーが発生しました: " + e.message);
                btn.disabled = false;
            }
        });
    </script>
    
    <script src="script.js"></script>
</body>
</html>