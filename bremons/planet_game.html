<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Planet Exploration</title>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        body { overflow: hidden; background: #000; touch-action: none; }
        
        .game-world {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden;
        }

        /* ËÉåÊôØÔºàÂÆáÂÆôÔºâ */
        .sky-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('./nightgame/background2.png');
            background-size: cover;
            z-index: 0;
        }

        /* Âú∞Èù¢ */
        .ground-layer {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 150px;
            z-index: 10;
            background-repeat: repeat-x;
            background-size: auto 100%;
        }

        /* ËÉåÊôØË£ÖÈ£æ */
        .decor-obj {
            position: absolute; bottom: 130px; z-index: 5;
            opacity: 0.8; filter: brightness(0.7);
            pointer-events: none;
        }

        /* „Éó„É¨„Ç§„É§„Éº */
        .player-char {
            position: absolute; 
            bottom: 120px; 
            left: 15%; 
            width: 80px; 
            z-index: 20;
            transition: transform 0.1s;
        }
        .player-walking {
            animation: walkBob 0.8s infinite alternate; 
        }
        @keyframes walkBob { from { transform: translateY(0); } to { transform: translateY(-5px); } }

        .player-damage { animation: damageFlash 0.5s infinite; }
        @keyframes damageFlash { 0% { opacity: 1; } 50% { opacity: 0.2; filter: hue-rotate(90deg); } 100% { opacity: 1; } }

        /* „Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÂÖ±ÈÄö */
        .game-obj { position: absolute; z-index: 15; will-change: transform; }

        .monster-obj { width: 80px; bottom: 125px; }
        .meteo-obj { width: 80px; top: -100px; }

        /* „Ç®„Éï„Çß„ÇØ„Éà */
        .effect-text {
            position: absolute; font-size: 32px; font-weight: bold; 
            color: #fff; text-shadow: 2px 2px 0 #000; pointer-events: none; z-index: 100;
            animation: popUpFade 0.8s forwards;
        }
        @keyframes popUpFade { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-50px) scale(1.5); opacity: 0; } }

        /* UIÈ°û */
        .hud-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; pointer-events: none;
        }
        .header-panel {
            position: absolute; top: 10px; right: 10px; 
            display: flex; gap: 10px;
            pointer-events: auto;
        }
        .status-box {
            background: rgba(0,0,0,0.7); border: 2px solid #fff; padding: 10px;
            border-radius: 8px; color: #fff; font-size: 16px;
        }
        .finish-btn {
            background: #e74c3c; color: #fff; border: 2px solid #fff;
            padding: 10px 20px; font-size: 16px; cursor: pointer; border-radius: 5px;
            font-family: 'DotGothic16', sans-serif;
        }

        /* --- Êà¶Ë°ì„Éû„ÉÉ„Éó (Êóß„É¨„Éº„ÉÄ„Éº) --- */
        .map-panel {
            position: absolute; top: 10px; left: 10px;
            width: 240px; height: 100px; /* Ê®™Èï∑ */
            background: rgba(0, 20, 0, 0.9);
            border: 2px solid #2ecc71;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 0 10px #2ecc71;
        }
        /* „Ç∞„É™„ÉÉ„ÉâÁ∑ö */
        .map-grid {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                linear-gradient(rgba(46, 204, 113, 0.2) 1px, transparent 1px),
                linear-gradient(90deg, rgba(46, 204, 113, 0.2) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        /* Âú∞Èù¢„É©„Ç§„É≥ */
        .map-ground-line {
            position: absolute; bottom: 10px; left: 0; width: 100%; height: 2px;
            background: #2ecc71;
        }
        /* „Éó„É¨„Ç§„É§„Éº„Ç¢„Ç§„Ç≥„É≥Ôºà„Éû„ÉÉ„ÉóÂÜÖÔºâ */
        .map-player-icon {
            position: absolute; bottom: 10px; left: 20px; /* Âõ∫ÂÆö‰ΩçÁΩÆ */
            width: 0; height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 12px solid #fff;
            transform: translate(-50%, 0);
            filter: drop-shadow(0 0 4px #fff);
        }
        /* Êïµ„ÉªÈöïÁü≥„Éâ„ÉÉ„Éà */
        .map-dot {
            position: absolute; width: 8px; height: 8px; border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.1s linear; /* „Å™„ÇÅ„Çâ„Åã„Å´Âãï„Åè */
        }
        .dot-monster { 
            background: #f1c40f; box-shadow: 0 0 5px #f1c40f; 
            width: 10px; height: 10px; border-radius: 2px; /* ÂõõËßí„Å£„ÅΩ„Åè */
        }
        .dot-meteor { 
            background: #e74c3c; box-shadow: 0 0 5px #e74c3c; 
            border: 2px solid #fff; /* Êû†Á∑ö */
        }

        /* Èü≥Â£∞Ë™çË≠ò„Ç§„É≥„Ç∏„Ç±„Éº„Çø */
        .mic-indicator {
            position: absolute; bottom: 10px; left: 10px;
            width: 200px; height: 10px; background: #333; border: 1px solid #fff;
        }
        .mic-bar { height: 100%; background: #2ecc71; width: 0%; }
        .voice-feedback {
            position: absolute; bottom: 30px; left: 10px;
            font-size: 24px; color: #f1c40f; text-shadow: 2px 2px 0 #000;
            opacity: 0; transition: opacity 0.2s;
        }

        /* „Çπ„Çø„Éº„Éà„Ç™„Éº„Éê„Éº„É¨„Ç§ */
        .start-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 200;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: #fff; text-align: center;
        }
    </style>
</head>
<body>

    <div class="game-container">
        <div class="game-world" id="gameWorld">
            <div class="sky-bg"></div>
            <div class="ground-layer" id="groundLayer"></div>
            <div id="decorLayer"></div>
            
            <img src="./nightgame/chara.png" class="player-char player-walking" id="player">
            
            <div id="objContainer"></div>
        </div>

        <div class="hud-layer">
            <div class="map-panel" id="mapPanel">
                <div class="map-grid"></div>
                <div class="map-ground-line"></div>
                <div class="map-player-icon"></div>
                </div>

            <div class="header-panel">
                <div class="status-box">
                    <div id="planetName">ÊÉëÊòü ???</div>
                    <div style="margin-top:5px;">
                        ÊçïÁç≤Êï∞: <span id="currentCount" style="color:#2ecc71; font-size:20px;">0</span> Âåπ
                    </div>
                </div>
                <button class="finish-btn" onclick="finishExploration()">Êé¢Á¥¢„ÇíÁµÇ„Åà„Çã</button>
            </div>

            <div class="voice-feedback" id="voiceFeedback">Ë™çË≠ò‰∏≠...</div>
            <div class="mic-indicator"><div class="mic-bar" id="micBar"></div></div>
        </div>

        <div class="start-overlay" id="startOverlay">
            <h2>Êé¢Á¥¢„Éü„ÉÉ„Ç∑„Éß„É≥ÈñãÂßã</h2>
            <p style="margin: 20px 0; line-height: 1.8;">
                „Éû„Ç§„ÇØ„Çí‰ΩøÁî®„Åó„Åæ„Åô„ÄÇ<br>
                <span style="color:#f1c40f">„Äå„ÅØ„Å£ÔºÅ„Äç</span>„Åß„É¢„É≥„Çπ„Çø„Éº„ÇíÊçïÁç≤<br>
                <span style="color:#e74c3c">„Äå„Å±„Å£ÔºÅ„Äç</span>„ÅßÈöïÁü≥„ÇíËøéÊíÉ<br>
                ÈöïÁü≥„Å´ÂΩì„Åü„Çã„Å® -5 ÂåπÔºÅ
            </p>
            <button class="pixel-btn start-btn" onclick="gameStart()">START</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCUWMn07YntLyB8m4q5-zHmiwjYOz1c_nk",
            authDomain: "bremons.firebaseapp.com",
            projectId: "bremons",
            storageBucket: "bremons.firebasestorage.app",
            messagingSenderId: "30413071482",
            appId: "1:30413071482:web:f62c34349b13e6c6ce47c3",
            measurementId: "G-4D4FCXGDBG"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const uid = localStorage.getItem('user_uid');
        if(!uid) location.href = 'index.html';

        // --- Ë®≠ÂÆö ---
        const PLANET_DATA = {
            1: { name: "ÊÉëÊòü„Ç§„É≥„Éè„É¨„Çπ", monster: "Usa", img: "./nightgame/red.png", id: "usa", groundColor: "#8B4513" },
            2: { name: "ÊÉëÊòü„Ç®„ÇØ„Çª„Éº„É´", monster: "Inv", img: "./nightgame/blue.png", id: "inv", groundColor: "#2F4F4F" },
            3: { name: "ÊÉëÊòü„Éó„Éç„Ç¶„Éû", monster: "Him", img: "./nightgame/yellow.png", id: "him", groundColor: "#DAA520" }
        };

        const urlParams = new URLSearchParams(window.location.search);
        const pId = urlParams.get('planet') || 1;
        const currentData = PLANET_DATA[pId];

        // Áä∂ÊÖãÁÆ°ÁêÜ
        let inventoryCount = 0;
        let isGameRunning = false;
        let gameSpeed = 1.5; 
        let groundOffset = 0;
        
        let gameObjects = []; 
        let decorObjects = [];
        let spawnTimer = 0;
        let decorTimer = 0;

        // Èü≥Â£∞Ë™çË≠òÁî®
        let audioContext, analyser, dataArray;
        const THOUSAND_INDEX = 24;
        const Ha_array = [0.09666242, 0.1010209, 0.04417039, 0.005689631, 0.005637815, 0.01925762, 0.03026361, 0.0365145, 0.0382, 0.01092663, 0.00179, 0.00457, 0.01878265, 0.055, 0.06935102, 0.0409, 0.0239, 0.0127, 0.027, 0.0401, 0.0292, 0.0226, 0.00922, 0.0389];
        const Pa_array = [0.03245861, 0.04191279, 0.01490102, 0.02225155, 0.009038828, 0.01731531, 0.005591091, 0.02210945, 0.0117, 0.0108, 0.0292, 0.0925, 0.135, 0.139, 0.0511, 0.0134, 0.00949, 0.0122, 0.014, 0.0142, 0.0084, 0.00948, 0.0178, 0.00705];
        let voiceCooldown = 0; 

        // ÂàùÊúüÂåñ
        document.getElementById('planetName').innerText = currentData.name;
        createGroundTexture(currentData.groundColor);
        
        const userRef = doc(db, "users", uid);
        getDoc(userRef).then(snap => {
            if(snap.exists() && snap.data().inventory) {
                inventoryCount = snap.data().inventory[currentData.id] || 0;
                updateCountDisplay();
            }
        });

        // ‚ñ† „Ç≤„Éº„É†ÈñãÂßã
        window.gameStart = async function() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                const microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                analyser.fftSize = 1024;
                dataArray = new Uint8Array(analyser.frequencyBinCount);

                document.getElementById('startOverlay').style.display = 'none';
                isGameRunning = true;
                requestAnimationFrame(gameLoop);

            } catch(e) {
                alert("„Éû„Ç§„ÇØ„ÅåË®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
            }
        };

        // ‚ñ† „É°„Ç§„É≥„É´„Éº„Éó
        function gameLoop() {
            if(!isGameRunning) return;

            groundOffset -= gameSpeed;
            if(groundOffset <= -128) groundOffset = 0; 
            document.getElementById('groundLayer').style.backgroundPosition = `${groundOffset}px bottom`;

            processVoice();

            spawnTimer++;
            if(spawnTimer > 180) { 
                if(Math.random() < 0.6) spawnMonster();
                else spawnMeteor();
                spawnTimer = Math.floor(Math.random() * 60); 
            }

            decorTimer++;
            if(decorTimer > 200) {
                spawnDecor();
                decorTimer = Math.floor(Math.random() * 100);
            }

            updateObjects();
            updateDecor();
            updateMapUI(); // Êõ¥Êñ∞Èñ¢Êï∞Âêç„ÇíÂ§âÊõ¥

            requestAnimationFrame(gameLoop);
        }

        // --- Èü≥Â£∞Ë™çË≠ò ---
        function processVoice() {
            if(voiceCooldown > 0) {
                voiceCooldown--;
                return;
            }
            analyser.getByteFrequencyData(dataArray);
            
            let sum = 0;
            for(let i=0; i<dataArray.length; i++) sum += dataArray[i];
            let average = sum / dataArray.length;
            document.getElementById('micBar').style.width = Math.min(100, average * 2) + "%";

            let max_amplitude = 0;
            let Ha_euclid = 0;
            let Pa_euclid = 0;

            for(let i=0; i<THOUSAND_INDEX; i++) {
                const val = dataArray[i] / 255.0;
                if(val > max_amplitude) max_amplitude = val;
                Ha_euclid += Math.pow(Ha_array[i] - val, 2);
                Pa_euclid += Math.pow(Pa_array[i] - val, 2);
            }

            const Ha_odds = 1 / (1 + Math.sqrt(Ha_euclid));
            const Pa_odds = 1 / (1 + Math.sqrt(Pa_euclid));

            if(max_amplitude < 0.05) return; 

            if(Ha_odds >= 0.83) {
                triggerAction("„ÅØ„Å£");
                voiceCooldown = 30; 
            } else if(Pa_odds >= 0.70) {
                triggerAction("„Å±„Å£");
                voiceCooldown = 30;
            }
        }

        function triggerAction(type) {
            const feedback = document.getElementById('voiceFeedback');
            feedback.innerText = type + "ÔºÅ";
            feedback.style.opacity = 1;
            setTimeout(() => feedback.style.opacity = 0, 500);

            const playerX = window.innerWidth * 0.15; 
            
            if(type === "„ÅØ„Å£") {
                const targets = gameObjects.filter(o => o.type === 'monster' && o.alive && o.x > playerX && o.x < playerX + 400);
                if(targets.length > 0) captureMonster(targets[0]);
            } else if(type === "„Å±„Å£") {
                const targets = gameObjects.filter(o => o.type === 'meteor' && o.alive && o.x > playerX - 100 && o.x < playerX + 600);
                if(targets.length > 0) destroyMeteor(targets[0]);
            }
        }

        // --- „Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÁÆ°ÁêÜ ---
        function spawnDecor() {
            const el = document.createElement('div');
            el.className = 'decor-obj';
            const types = ['üåµ', 'ü™®', '‚õ∞Ô∏è'];
            el.innerText = types[Math.floor(Math.random() * types.length)];
            el.style.fontSize = (Math.random() * 30 + 30) + 'px';
            document.getElementById('decorLayer').appendChild(el);
            
            decorObjects.push({
                el: el,
                x: window.innerWidth + 50
            });
        }

        function spawnMonster() {
            const el = document.createElement('img');
            el.src = currentData.img;
            el.className = 'game-obj monster-obj';
            document.getElementById('objContainer').appendChild(el);
            
            gameObjects.push({
                el: el,
                type: 'monster',
                x: window.innerWidth + 100,
                y: 0, 
                alive: true
            });
        }

        function spawnMeteor() {
            const el = document.createElement('img');
            el.src = './nightgame/meteo.png';
            el.className = 'game-obj meteo-obj';
            document.getElementById('objContainer').appendChild(el);
            
            const startX = window.innerWidth + Math.random() * 200; 
            const startY = -150; 
            
            const targetX = window.innerWidth * 0.15; 
            const targetY = window.innerHeight - 150; 

            const dx = targetX - startX;
            const dy = targetY - startY;
            const angleRad = Math.atan2(dy, dx);
            const speed = gameSpeed + 2; 

            const vx = Math.cos(angleRad) * speed;
            const vy = Math.sin(angleRad) * speed;

            const angleDeg = (angleRad * 180 / Math.PI) - 90;
            el.style.transform = `rotate(${angleDeg}deg)`;

            gameObjects.push({
                el: el,
                type: 'meteor',
                x: startX,
                y: startY,
                vx: vx,
                vy: vy,
                alive: true
            });
        }

        function updateDecor() {
            decorObjects.forEach(obj => {
                obj.x -= gameSpeed * 0.8; 
                obj.el.style.left = obj.x + 'px';
                if(obj.x < -100) {
                    obj.el.remove();
                    obj.dead = true;
                }
            });
            decorObjects = decorObjects.filter(o => !o.dead);
        }

        function updateObjects() {
            const playerX = window.innerWidth * 0.15;
            const pHitX = playerX + 40; 
            const pHitY = window.innerHeight - 120; 

            gameObjects.forEach(obj => {
                if(!obj.alive) return;

                if(obj.type === 'monster') {
                    obj.x -= gameSpeed;
                    obj.el.style.left = obj.x + 'px';

                    if(obj.x < playerX + 80 && obj.x > playerX + 70) {
                        obj.alive = false; 
                        obj.el.style.transition = "none"; 
                        obj.el.animate([
                            { transform: 'translate(0, 0)' },
                            { transform: 'translate(-200px, -150px) rotate(-45deg)' }, 
                            { transform: 'translate(-400px, 0) rotate(-90deg)' } 
                        ], { duration: 1000, fill: 'forwards' });
                        
                        setTimeout(() => removeObject(obj), 1000);
                        showEffect("ÈÄÉ„Åí„Çâ„Çå„Åü...", "#aaa", playerX, pHitY - 50);
                    }
                } else if(obj.type === 'meteor') {
                    obj.x += obj.vx;
                    obj.y += obj.vy;
                    obj.el.style.left = obj.x + 'px';
                    obj.el.style.top = obj.y + 'px';

                    if(Math.abs(obj.x - playerX) < 50 && Math.abs(obj.y - pHitY) < 50) {
                        playerHit(obj);
                    }
                    
                    if(obj.y > window.innerHeight) removeObject(obj);
                }
            });
        }

        // --- Êà¶Ë°ì„Éû„ÉÉ„ÉóÊõ¥Êñ∞ ---
        function updateMapUI() {
            const mapPanel = document.getElementById('mapPanel');
            const dots = mapPanel.querySelectorAll('.dot-generated');
            dots.forEach(d => d.remove());

            const playerX = window.innerWidth * 0.15;
            const range = 1200; // Êé¢Áü•ÁØÑÂõ≤ (px)
            const mapW = 240; // „Éû„ÉÉ„ÉóUI„ÅÆÂπÖ
            const mapH = 100; // „Éû„ÉÉ„ÉóUI„ÅÆÈ´ò„Åï

            gameObjects.forEach(obj => {
                if(!obj.alive) return;
                
                const dx = obj.x - playerX;
                // ÁØÑÂõ≤ÂÜÖ„Å´„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„ÅøË°®Á§∫
                if(dx > -100 && dx < range) {
                    const dot = document.createElement('div');
                    dot.className = 'map-dot dot-generated';
                    
                    if(obj.type === 'monster') dot.classList.add('dot-monster');
                    else dot.classList.add('dot-meteor');

                    // „Éó„É¨„Ç§„É§„Éº‰ΩçÁΩÆ„Çí„Éû„ÉÉ„ÉóÂ∑¶Á´Ø(20px)„Å®„Åô„Çã
                    // „Éû„ÉÉ„Éó‰∏ä„ÅÆXÂ∫ßÊ®ô: 20px(„Éó„É¨„Ç§„É§„Éº) + (dx / range) * (ÊÆã„Çä„ÅÆÂπÖ)
                    const mapX = 20 + (dx / range) * (mapW - 40);
                    
                    // „Éû„ÉÉ„Éó‰∏ä„ÅÆYÂ∫ßÊ®ô
                    let mapY = 0;
                    if(obj.type === 'meteor') {
                        // ‰∏äÁ©∫(-100)„Åã„ÇâÂú∞Èù¢(innerHeight)„Åæ„Åß„Çí„Éû„ÉÉ„Éó0~100%„Å´
                        const groundY = window.innerHeight - 120;
                        const progressY = (obj.y + 100) / (groundY + 100);
                        mapY = progressY * (mapH - 10); // ‰∏ãÁ´Ø10px„ÅØÂú∞Èù¢„É©„Ç§„É≥
                    } else {
                        mapY = mapH - 10; // Âú∞Èù¢Âõ∫ÂÆö
                    }

                    // ÁØÑÂõ≤Â§ñ„ÇØ„É™„ÉÉ„Éó
                    if(mapX > mapW) return;

                    dot.style.left = mapX + 'px';
                    dot.style.top = mapY + 'px';
                    mapPanel.appendChild(dot);
                }
            });
        }

        function captureMonster(obj) {
            obj.alive = false;
            const pRect = document.getElementById('player').getBoundingClientRect();
            const mRect = obj.el.getBoundingClientRect();
            const deltaX = pRect.left - mRect.left;
            const deltaY = pRect.top - mRect.top;

            obj.el.animate([
                { transform: 'translate(0, 0) scale(1)', opacity: 1 },
                { transform: `translate(${deltaX}px, ${deltaY}px) scale(0.1)`, opacity: 0 }
            ], { duration: 400, easing: 'ease-in', fill: 'forwards' });

            setTimeout(() => removeObject(obj), 400);

            inventoryCount++;
            updateCountDisplay();
            showEffect("GET!", "#f1c40f", pRect.left, pRect.top - 50);
        }

        function destroyMeteor(obj) {
            obj.alive = false;
            obj.el.animate([
                { transform: `rotate(${getRotation(obj.el)}deg) scale(1)`, opacity: 1, filter: 'brightness(2)' },
                { transform: `rotate(${getRotation(obj.el) + 180}deg) scale(2)`, opacity: 0 }
            ], { duration: 300, fill: 'forwards' });
            
            setTimeout(() => removeObject(obj), 300);
            showEffect("BREAK!", "#e74c3c", obj.x, obj.y);
        }

        function getRotation(el) {
            const st = window.getComputedStyle(el, null);
            const tr = st.getPropertyValue("transform");
            if(tr === 'none') return 0;
            const values = tr.split('(')[1].split(')')[0].split(',');
            const a = values[0];
            const b = values[1];
            return Math.round(Math.atan2(b, a) * (180/Math.PI));
        }

        function playerHit(obj) {
            obj.alive = false;
            removeObject(obj);
            
            inventoryCount = Math.max(0, inventoryCount - 5);
            updateCountDisplay();
            
            const p = document.getElementById('player');
            p.classList.add('player-damage');
            setTimeout(() => p.classList.remove('player-damage'), 1000);
            
            showEffect("-5...", "#ff0000", window.innerWidth * 0.15, window.innerHeight - 200);
        }

        function removeObject(obj) {
            obj.alive = false;
            if(obj.el && obj.el.parentNode) obj.el.parentNode.removeChild(obj.el);
        }

        function updateCountDisplay() {
            document.getElementById('currentCount').innerText = inventoryCount;
        }

        function showEffect(text, color, x, y) {
            const el = document.createElement('div');
            el.className = 'effect-text';
            el.innerText = text;
            el.style.color = color;
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        function createGroundTexture(baseColor) {
            const canvas = document.createElement('canvas');
            canvas.width = 128; 
            canvas.height = 150;
            const ctx = canvas.getContext('2d');

            ctx.fillStyle = baseColor;
            ctx.fillRect(0, 0, 128, 150);

            ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.beginPath();
            ctx.moveTo(0, 20);
            ctx.bezierCurveTo(40, 0, 80, 40, 128, 10);
            ctx.lineTo(128, 150);
            ctx.lineTo(0, 150);
            ctx.fill();

            for(let i=0; i<300; i++) {
                ctx.fillStyle = Math.random() < 0.5 ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.05)';
                const x = Math.floor(Math.random() * 128);
                const y = Math.floor(Math.random() * 150);
                ctx.fillRect(x, y, 2, 2);
            }

            const dataUrl = canvas.toDataURL();
            document.getElementById('groundLayer').style.backgroundImage = `url(${dataUrl})`;
        }

        window.finishExploration = async function() {
            isGameRunning = false;
            const saveObj = {};
            saveObj[`inventory.${currentData.id}`] = inventoryCount;

            try {
                const btn = document.querySelector('.finish-btn');
                btn.innerText = "‰øùÂ≠ò‰∏≠...";
                btn.disabled = true;
                await setDoc(userRef, saveObj, { merge: true });
                window.location.href = "stage_select.html";
            } catch(e) {
                console.error(e);
                alert("‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
                window.location.href = "stage_select.html";
            }
        };
    </script>
</body>
</html>