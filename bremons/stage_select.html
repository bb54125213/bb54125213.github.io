<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚¹ãƒ†ãƒ¼ã‚¸é¸æŠ - BREMONS</title>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .stage-type-label { font-size: 10px; background: #555; padding: 2px 5px; border-radius: 3px; margin-right: 5px; }
        .type-planet { background: #27ae60; color: #fff; } 
        .type-flight { background: #2980b9; color: #fff; } 
        .cost-info { font-size: 12px; color: #f39c12; margin-top: 5px; }
        .owned-info { font-size: 14px; color: #fff; text-align: right; margin-top:5px; font-weight:bold; }
        .insufficient { opacity: 0.6; filter: grayscale(100%); pointer-events: none; border-color: #555 !important; }
        .insufficient .stage-status { color: #999 !important; }
        /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ */
        .stage-list { margin-top: 10px; padding-right: 5px; } /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã¨ã®ä½™ç™½ */
        .stage-panel { margin-bottom: 15px; }
    </style>
</head>
<body>
    <audio id="bgm" src="./bgm/GuideToAdventure.mp3" loop autoplay></audio>

    <div class="game-container stage-select-screen">
        <div class="scrolling-bg"></div>
        <div class="ui-layer">
            <div class="title-area" style="margin-top: 20px;">
                <h1 class="game-title" style="font-size: 32px;">BREMONS</h1>
            </div>

            <header class="stage-select-header">
                <button onclick="location.href='index.html'" class="pixel-btn back-btn">â†æˆ»ã‚‹</button>
                <h2 class="screen-title">ãƒŸãƒƒã‚·ãƒ§ãƒ³é¸æŠ</h2>
            </header>

            <div id="loadingMsg" style="text-align:center; margin-top:20px;">ãƒ‡ãƒ¼ã‚¿ç¢ºèªä¸­...</div>

            <div class="stage-list hidden" id="stageList">
                <div id="panel_planet_1" class="stage-panel unlocked current" onclick="goPlanet(1)">
                    <div class="panel-header">
                        <span><span class="stage-type-label type-planet">æ¢ç´¢</span>PLANET A</span>
                        <span class="stage-status">OPEN</span>
                    </div>
                    <div class="stage-name">æƒ‘æ˜Ÿã‚¤ãƒ³ãƒãƒ¬ã‚¹</div>
                    <div class="stage-info">ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: Usa (Red)</div>
                    <div class="owned-info">æ‰€æŒ: <span id="count_usa" style="color:#2ecc71">0</span> åŒ¹</div>
                </div>

                <div id="panel_flight_1" class="stage-panel locked" onclick="goFlight(1, 'usa')">
                    <div class="panel-header">
                        <span><span class="stage-type-label type-flight">é£›è¡Œ</span>FLIGHT 1</span>
                        <span id="status_flight_1" class="stage-status">ğŸ”’</span>
                    </div>
                    <div class="stage-name">ã‚¨ã‚¯ã‚»ãƒ¼ãƒ«ã¸ã®æ—…è·¯</div>
                    <div class="cost-info">å¿…è¦ã‚³ã‚¹ãƒˆ: Usa 1åŒ¹ / å›</div>
                    <div class="stage-info">è·é›¢: 1å„„km</div>
                </div>

                <div id="panel_planet_2" class="stage-panel locked" onclick="goPlanet(2)">
                    <div class="panel-header">
                        <span><span class="stage-type-label type-planet">æ¢ç´¢</span>PLANET B</span>
                        <span id="status_planet_2" class="stage-status">ğŸ”’</span>
                    </div>
                    <div class="stage-name">æƒ‘æ˜Ÿã‚¨ã‚¯ã‚»ãƒ¼ãƒ«</div>
                    <div class="stage-info">ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: Inv (Blue)</div>
                    <div class="owned-info">æ‰€æŒ: <span id="count_inv" style="color:#2ecc71">0</span> åŒ¹</div>
                </div>

                <div id="panel_flight_2" class="stage-panel locked" onclick="goFlight(2, 'inv')">
                    <div class="panel-header">
                        <span><span class="stage-type-label type-flight">é£›è¡Œ</span>FLIGHT 2</span>
                        <span id="status_flight_2" class="stage-status">ğŸ”’</span>
                    </div>
                    <div class="stage-name">ãƒ—ãƒã‚¦ãƒã¸ã®æ—…è·¯</div>
                    <div class="cost-info">å¿…è¦ã‚³ã‚¹ãƒˆ: Inv 1åŒ¹ / å›</div>
                    <div class="stage-info">è·é›¢: 1.5å„„km</div>
                </div>

                 <div id="panel_planet_3" class="stage-panel locked" onclick="goPlanet(3)">
                    <div class="panel-header">
                        <span><span class="stage-type-label type-planet">æ¢ç´¢</span>PLANET C</span>
                        <span id="status_planet_3" class="stage-status">ğŸ”’</span>
                    </div>
                    <div class="stage-name">æƒ‘æ˜Ÿãƒ—ãƒã‚¦ãƒ</div>
                    <div class="stage-info">ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: Him (Yellow)</div>
                    <div class="owned-info">æ‰€æŒ: <span id="count_him" style="color:#2ecc71">0</span> åŒ¹</div>
                </div>
            </div>
            
            <footer class="footer-area" style="margin-top: auto;">
                <div class="version">Ver 2.4.0</div>
            </footer>
        </div>
        
        <div id="confirmDialog" class="custom-dialog-overlay hidden">
            <div class="custom-dialog-box">
                <p id="confirmMsg" class="dialog-msg">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</p>
                <div class="dialog-btns">
                    <button id="btnYes" class="dialog-btn btn-yes">ã¯ã„</button>
                    <button id="btnNo" class="dialog-btn btn-no">ã„ã„ãˆ</button>
                </div>
            </div>
        </div>
        
        <div id="alertDialog" class="custom-dialog-overlay hidden">
            <div class="custom-dialog-box">
                <p id="alertMsg" class="dialog-msg">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</p>
                <button onclick="closeAlert()" class="dialog-btn btn-no">OK</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCUWMn07YntLyB8m4q5-zHmiwjYOz1c_nk",
            authDomain: "bremons.firebaseapp.com",
            projectId: "bremons",
            storageBucket: "bremons.firebasestorage.app",
            messagingSenderId: "30413071482",
            appId: "1:30413071482:web:f62c34349b13e6c6ce47c3",
            measurementId: "G-4D4FCXGDBG"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const uid = localStorage.getItem('user_uid');
        if(!uid) location.href = 'index.html';

        let inventory = { usa: 0, inv: 0, him: 0 };

        async function init() {
            try {
                const userRef = doc(db, "users", uid);
                const userSnap = await getDoc(userRef);
                if(userSnap.exists()) {
                    const data = userSnap.data();
                    inventory = data.inventory || { usa: 0, inv: 0, him: 0 };
                }
                document.getElementById('count_usa').innerText = inventory.usa || 0;
                document.getElementById('count_inv').innerText = inventory.inv || 0;
                document.getElementById('count_him').innerText = inventory.him || 0;

                const s1Ref = doc(db, "users", uid, "stages", "stage_1");
                const s1Snap = await getDoc(s1Ref);
                const s1Dist = s1Snap.exists() ? (s1Snap.data().totalDistance || 0) : 0;

                const s2Ref = doc(db, "users", uid, "stages", "stage_2");
                const s2Snap = await getDoc(s2Ref);
                const s2Dist = s2Snap.exists() ? (s2Snap.data().totalDistance || 0) : 0;

                const f1Unlocked = s1Dist >= 100000000;
                unlock("panel_flight_1", "status_flight_1", f1Unlocked);
                checkCost("panel_flight_1", "usa");

                if(f1Unlocked) {
                    unlock("panel_planet_2", "status_planet_2", false);
                    const f2Unlocked = s2Dist >= 150000000;
                    unlock("panel_flight_2", "status_flight_2", f2Unlocked);
                    checkCost("panel_flight_2", "inv");
                }

                if(s2Dist >= 150000000) {
                    unlock("panel_planet_3", "status_planet_3", false);
                }

                document.getElementById('loadingMsg').classList.add('hidden');
                document.getElementById('stageList').classList.remove('hidden');

            } catch(e) { console.error(e); }
        }

        function unlock(panelId, statusId, isCleared) {
            const p = document.getElementById(panelId);
            const s = document.getElementById(statusId);
            if(!p) return;
            p.classList.remove('locked');
            p.classList.add('unlocked');
            if(isCleared) {
                p.classList.add('cleared');
                s.innerText = "CLEAR!";
            } else {
                p.classList.add('current');
                s.innerText = "GO!";
            }
        }

        function checkCost(panelId, monsterId) {
            const p = document.getElementById(panelId);
            if(p.classList.contains('locked')) return;
            const count = inventory[monsterId] || 0;
            if(count < 1) {
                p.classList.add('insufficient');
                p.querySelector('.stage-status').innerText = "NO COST";
            }
        }

        init();

        window.goPlanet = function(n) {
            if(document.getElementById(`panel_planet_${n}`).classList.contains('locked')) return;
            window.location.href = `planet_game.html?planet=${n}`;
        };

        // â˜…ã‚«ã‚¹ã‚¿ãƒ ãƒ€ã‚¤ã‚¢ãƒ­ã‚°åˆ¶å¾¡
        window.goFlight = function(n, monsterId) {
            const p = document.getElementById(`panel_flight_${n}`);
            if(p.classList.contains('locked')) return;
            if(p.classList.contains('insufficient')) return;
            
            showConfirm(`ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼(${monsterId})ã‚’1åŒ¹æ¶ˆè²»ã—ã¦å‡ºç™ºã—ã¾ã™ã‹ï¼Ÿ`, () => {
                window.location.href = `game_main.html?stage=${n}&cost=${monsterId}`;
            });
        };

        // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤ºé–¢æ•°
        function showConfirm(msg, onYes) {
            const dialog = document.getElementById('confirmDialog');
            document.getElementById('confirmMsg').innerText = msg;
            dialog.classList.remove('hidden');
            
            document.getElementById('btnYes').onclick = () => {
                dialog.classList.add('hidden');
                onYes();
            };
            document.getElementById('btnNo').onclick = () => {
                dialog.classList.add('hidden');
            };
        }
        
        window.closeAlert = function() {
            document.getElementById('alertDialog').classList.add('hidden');
        };
        
        document.body.addEventListener('click', function() {
            var bgm = document.getElementById('bgm');
            if(bgm.paused) bgm.play();
        }, { once: true });
        
    </script>
    <script src="script.js"></script>
</body>
</html>