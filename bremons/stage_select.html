<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚¹ãƒ†ãƒ¼ã‚¸é¸æŠ - BREMONS</title>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã®è¡¨ç¤ºç”¨ */
        #loadingMsg { text-align: center; margin-top: 20px; color: #f1c40f; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <audio id="bgm" src="./bgm/GuideToAdventure.mp3" loop autoplay></audio>

    <div class="game-container stage-select-screen">
        <div class="scrolling-bg"></div>
        <div class="floating-layer" id="floatingLayer"></div>
        
        <div class="ui-layer">
            
            <div class="title-area" style="margin-top: 20px;">
                <h1 class="game-title" style="font-size: 32px;">BREMONS</h1>
            </div>

            <header class="stage-select-header">
                <button onclick="location.href='index.html'" class="pixel-btn back-btn">â†æˆ»ã‚‹</button>
                <h2 class="screen-title">ã‚¹ãƒ†ãƒ¼ã‚¸é¸æŠ</h2>
            </header>

            <div id="loadingMsg">ãƒ‡ãƒ¼ã‚¿ç¢ºèªä¸­...</div>

            <div class="stage-list hidden" id="stageList">
                
                <div id="panel_stage_1" class="stage-panel unlocked current" onclick="selectStage(1)">
                    <div class="panel-header">
                        <span class="stage-num">STAGE 1</span>
                        <span id="status_stage_1" class="stage-status">READY</span>
                    </div>
                    <div class="stage-name">æƒ‘æ˜Ÿã‚¤ãƒ³ãƒãƒ¬ã‚¹ã¸</div>
                    <div class="stage-info">è·é›¢: 1å„„km</div> </div>

                <div id="panel_stage_2" class="stage-panel locked">
                    <div class="panel-header">
                        <span class="stage-num">STAGE 2</span>
                        <span id="status_stage_2" class="stage-status">ğŸ”’</span>
                    </div>
                    <div class="stage-name">æƒ‘æ˜Ÿã‚¨ã‚¯ã‚»ãƒ¼ãƒ«ã¸</div>
                    <div class="stage-info">è·é›¢: 1å„„5åƒä¸‡km</div>
                </div>

                <div id="panel_stage_3" class="stage-panel locked">
                    <div class="panel-header">
                        <span class="stage-num">STAGE 3</span>
                        <span id="status_stage_3" class="stage-status">ğŸ”’</span>
                    </div>
                    <div class="stage-name">æƒ‘æ˜Ÿãƒ—ãƒã‚¦ãƒã¸</div>
                    <div class="stage-info">è©³ç´°ä¸æ˜</div>
                </div>

            </div>
            
            <footer class="footer-area" style="margin-top: auto;">
                <div class="version">Ver 2.1.0</div>
            </footer>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCUWMn07YntLyB8m4q5-zHmiwjYOz1c_nk",
            authDomain: "bremons.firebaseapp.com",
            projectId: "bremons",
            storageBucket: "bremons.firebasestorage.app",
            messagingSenderId: "30413071482",
            appId: "1:30413071482:web:f62c34349b13e6c6ce47c3",
            measurementId: "G-4D4FCXGDBG"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ã‚¹ãƒ†ãƒ¼ã‚¸ã®ç›®æ¨™è·é›¢è¨­å®š (game_script.jsã¨åˆã‚ã›ã‚‹)
        const STAGE_GOALS = {
            1: 100000000,
            2: 150000000,
            3: 300000000
        };

        const uid = localStorage.getItem('user_uid');
        if(!uid) {
            alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");
            location.href = 'index.html';
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¸æƒ…å ±ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦UIæ›´æ–°
        async function checkStageStatus() {
            // STAGE 1 ã®é€²æ—å–å¾—
            const s1Ref = doc(db, "users", uid, "stages", "stage_1");
            const s1Snap = await getDoc(s1Ref);
            const s1Dist = s1Snap.exists() ? (s1Snap.data().totalDistance || 0) : 0;

            // STAGE 2 ã®é€²æ—å–å¾—
            const s2Ref = doc(db, "users", uid, "stages", "stage_2");
            const s2Snap = await getDoc(s2Ref);
            const s2Dist = s2Snap.exists() ? (s2Snap.data().totalDistance || 0) : 0;

            // === UIæ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯ ===
            
            // STAGE 1: å¸¸ã«è§£æ”¾ã€‚ã‚¯ãƒªã‚¢ã—ãŸã‹åˆ¤å®š
            if (s1Dist >= STAGE_GOALS[1]) {
                markAsCleared(1);
                unlockStage(2); // 1ã‚¯ãƒªã‚¢ãªã‚‰2ã‚’è§£æ”¾
            } else {
                markAsCurrent(1);
            }

            // STAGE 2: è§£æ”¾ã•ã‚Œã¦ã„ã‚‹å ´åˆã€ã‚¯ãƒªã‚¢åˆ¤å®š
            if (s1Dist >= STAGE_GOALS[1]) {
                if (s2Dist >= STAGE_GOALS[2]) {
                    markAsCleared(2);
                    unlockStage(3); // 2ã‚¯ãƒªã‚¢ãªã‚‰3ã‚’è§£æ”¾
                } else {
                    markAsCurrent(2);
                }
            }

            // ãƒ­ãƒ¼ãƒ‰å®Œäº†
            document.getElementById('loadingMsg').classList.add('hidden');
            document.getElementById('stageList').classList.remove('hidden');
        }

        // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: ã‚¯ãƒªã‚¢æ¸ˆã¿ã®è¦‹ãŸç›®ã«ã™ã‚‹
        function markAsCleared(num) {
            const p = document.getElementById(`panel_stage_${num}`);
            const s = document.getElementById(`status_stage_${num}`);
            p.className = "stage-panel unlocked cleared";
            p.onclick = () => selectStage(num);
            s.innerText = "CLEAR!";
        }

        // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: ç¾åœ¨æŒ‘æˆ¦ä¸­ã®è¦‹ãŸç›®ã«ã™ã‚‹
        function markAsCurrent(num) {
            const p = document.getElementById(`panel_stage_${num}`);
            const s = document.getElementById(`status_stage_${num}`);
            p.className = "stage-panel unlocked current";
            p.onclick = () => selectStage(num);
            s.innerText = "GO!";
        }

        // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: ãƒ­ãƒƒã‚¯è§£é™¤ï¼ˆã¾ã ã‚¯ãƒªã‚¢ã¯ã—ã¦ãªã„çŠ¶æ…‹ï¼‰
        function unlockStage(num) {
            // unlockå‡¦ç†ã¯ markAsCurrent ã®ä¸­ã§å®Ÿè³ªå…¼ã­ã¦ã„ã‚‹ãŒã€
            // ã€Œã¾ã æŒ‘æˆ¦æ¨©ã‚’å¾—ãŸã°ã‹ã‚Šã€ã®çŠ¶æ…‹ã‚’æ˜ç¤ºçš„ã«ã™ã‚‹ãªã‚‰ã“ã“
            // ä»Šå›ã¯å˜ç´”ã« markAsCurrent ãŒå‘¼ã°ã‚Œã‚Œã°OK
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¸ã®ç´ã¥ã‘
        window.selectStage = function(n) {
            window.location.href = `game_main.html?stage=${n}`;
        };

        // å®Ÿè¡Œ
        checkStageStatus();

        // BGMå¯¾ç­–
        document.body.addEventListener('click', function() {
            var bgm = document.getElementById('bgm');
            if(bgm.paused) bgm.play();
        }, { once: true });
    </script>

    <script src="script.js"></script>
</body>
</html>